<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Mathematic Form Transfer Simulation</title>
		<style>
			canvas{
				border: solid 1px green;
			}
		</style>
	</head>
	<body>
		<!--
						table design reference:
						http://www.wibibi.com/info.php?tid=441
		-->
		<table>
				<tr>
					<td><p id = "inputMathForm">這是一個可以輸入數學中序式後，可以轉成前序或後序式的模擬程式</p></td>
				</tr>	
		</table>
		<hr>	
		<form name = "mathForm" id="mathForm">
			<table  style="border:3px #FFD382 dashed;" cellpadding="10" >
				<tr>
					<td>
					
					<table>
						<tr>
							<td><p id = "inputMathForm">輸入中序：</p></td>
							<td><input type=text value="" id = inputInfix size="30" ></td>
						</tr>	
					</table>
					<table>
						<tr>
							<td><p id = "changeTo">轉換為：</p></td>
							<td>
								<input type="radio" name="fix" value="前序" onClick = "fixChoice();">前序
							</td>
							<td>
								<input type="radio" name="fix" value="後序" onClick = "fixChoice();">後序
							</td>
							<td>
								<p id = "fixWord"></p>
							</td>
						</tr>	
					</table>
					<table>
						<tr>
							<td><p id = "modePrompt">操作模式：</p></td>
							<td>
								<input type="radio" name="mode" value="Step mode" onClick = "modeChoice();">Step mode
							</td>
							<td>
								<input type="radio" name="mode" value="Run all" onClick = "modeChoice();">Run all
							</td>
							<td>
								<p id = "modeWord"></p>
							</td>
						</tr>	
					</table>
					<table>
						<tr>
							<td><p id = "speedPrompt">Speed：</p></td>
							<td>
								<input type="radio" name="speed" value="快" onClick = "speedChoice();">快
							</td>
							<td>
								<input type="radio" name="speed" value="中" onClick = "speedChoice();">中
							</td>
							<td>
								<input type="radio" name="speed" value="慢" onClick = "speedChoice();">慢
							</td>
							<td>
								<p id = "speedWord"></p>
							</td>
						</tr>	
					</table>
					<table>
						<tr>
							<td><p id = "speedPrompt">Step mode請按這；</p></td>
							<td><input type = "button" style=" width:100px;height:30px;font-size:15px;border:2px green solid " value = "Next" onClick = "stepExe();" id = "stepButton" ></td>
						</tr>
					</table>

					<table>
						<tr>
							<td><p id = "speedPrompt">你可以在這裡輸入你的答案：</p></td>
							<td><input type=text value="" id=userAnswer size="30" ></td>
						</tr>
					</table>

					<table>
						<tr>
							<td><p id = "speedPrompt">系統處理結果：</p></td>
							<td><input type=text value="" id=systemAnswer size="30" readonly="readonly"></td>
						</tr>
					</table>

					<table>
						<tr>
							<td><p id = "speedPrompt">Self-test比對結果：</p></td>
							<td><p id = "userResult"></p></td>
						</tr>
					</table>

					<!--
						Button design reference:
						http://csscodefile.blogspot.tw/2015/03/html-button.html
					-->
					<table>
						<tr>
							<td><input type = "button" style=" width:100px;height:30px;font-size:15px; border:2px green solid" value = "Clear all" onClick = "clearAll();" id = "clearButton"></td>
							<td><input type = "button" style="width:100px;height:30px;font-size:15px; border:2px green solid" value = "Check answer" onClick = "checkAnswer();" id = "answerButton" ></td>
						</tr>
					</table>
					<td>
					<td>
						<table>
							<tr>
								<td><p id = "stackWord">Stack狀態：</p></td>
							</tr>
							<tr>
								<td><input type=text style="border-top:3px black solid; border-left:3px black solid; border-bottom:3px black solid;" value="" id=stackText size="80" readonly="readonly"></td>	
							</tr>
						</table>

						<table>
							<tr>
								<td><p id = "location">top</p></td>
								
							</tr>
							<tr>
								
								<td><p id = "space1"></p></td>
								<td><p id = "space2"></p></td>
							</tr>
							<tr>
								<td><p id = "space3"></p></td>
								<td><p id = "space4"></p></td>
							</tr>
						</table>

						<table>
							<tr>
								<td><p id = "outputWord">output：</p></td>
								
							</tr>
							<tr>
								
								<td><p id = "space5"></p></td>
								<td><p id = "space6"></p></td>
							</tr>
							<tr>
								<td><p id = "space7"></p></td>
								<td><p id = "space8"></p></td>
							</tr>
							<tr>
								<td><input type=text value="" id=outputText size="80" readonly="readonly"></td>
							</tr>
						</table>

						<table>
							<tr>
								<td><p id = "allStepWord">目前過程：</p></td>
								
							</tr>
							<tr>
								<td><textarea name="Content" style="width:570px;height:100px;" id=currentStepTextArea readonly="readonly" ></textarea></td>
							</tr>
						</table>

						<table>
							<tr>
								<td><p id = "allStepWord">轉換過程：</p></td>
								
							</tr>
							<tr>
								<td><textarea name="Content" style="width:570px;height:200px;" id=allStepTextArea readonly="readonly" ></textarea></td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
		</form>
	</body>
	<script>
		// The function will be invoke, when you open the HTML file
		window.onload = function (){
			clearAll();
		}

		var mode = -1;
		var speed = -1;
		var fix = -1;// fix = 0 prefix,fix = 1 postfix
		var fixString = "";
		var infixArray;
		var stackStringStore = "";
		var outputStringStore = "";
		var infixArrayIndex = 0;
		var popContinue = 0;
		var first = 1;
		var allStepWordString = "";
		var step = 0;
		var currentStr = "";
		var operator = "";
		var firstFind = 1;
		var isAlreadyDecide = 0;

		function fixChoice(){
				var form = document.getElementById("mathForm");
				var result = document.getElementById("fixWord");
			
				for (var i = 0; i < form.fix.length; i++) {
					if ( form.fix[i].checked ) {
						result.innerHTML = "<strong>"+"選擇 " + form.fix[i].value + "</strong>";
						fix = i;
						for (var i = 0; i < form.mode.length; i++) {
							form.mode[i].disabled = false;
						}			
						break;
					}
				}
		}// end function fixChoice()

		function fixClear(){
				var form = document.getElementById("mathForm");
				var result = document.getElementById("fixWord");
				for (var i = 0; i < form.fix.length; i++) {
					form.fix[i].checked = false;
				}

				result.innerHTML = "";

				for (var i = 0; i < form.mode.length; i++) {
					form.mode[i].disabled = true;
				}	

				
				fix = -1;
		}// end function fixClear()

		function modeChoice(){
				var form = document.getElementById("mathForm");
				var result = document.getElementById("modeWord");
			
				for (var i = 0; i < form.mode.length; i++) {
					if ( form.mode[i].checked ) {
						result.innerHTML = "<strong>" + "選擇 " + form.mode[i].value + "</strong>";
						mode = i;			
						break;
					}
				}
				if(mode == 0){
					for (var i = 0; i < form.speed.length; i++) {
						form.speed[i].disabled = true;
						form.speed[i].checked = false;
					}
					speedClear();
				}else{
					for (var i = 0; i < form.speed.length; i++) {
						form.speed[i].disabled = false;
					}
				}
		}// end function modeChoice()

		function modeClear(){
				var form = document.getElementById("mathForm");
				var result = document.getElementById("modeWord");
				for (var i = 0; i < form.mode.length; i++) {
					form.mode[i].checked = false;

				}
				result.innerHTML = "";
				mode = -1;

		}// end function modeClear()

		function speedChoice(){
				var form = document.getElementById("mathForm");
				var result = document.getElementById("speedWord");
			
				for (var i = 0; i < form.speed.length; i++) {
					if ( form.speed[i].checked ) {
						result.innerHTML = "<strong>" + "選擇 " + form.speed[i].value + "速</strong>";
						speed = i;			
						break;
					}
				}
		}// end function modeChoice()

		function speedClear(){
				var form = document.getElementById("mathForm");
				var result = document.getElementById("speedWord");
			
				for (var i = 0; i < form.speed.length; i++) {
					form.speed[i].checked = false;
					form.speed[i].disabled = true;
				}
				result.innerHTML = "";
				speed = -1;
		}// end function modeClear()

		function fixPreHandle(){
			var fixString = document.getElementById("inputInfix");
			var temp;// is a character array
			var str = ""; // temporarily store digit.
			var first = 1;
			var digitIsNeedToFind = 0;
			if(mode != -1){ // choose mode
				if(fix != -1){ // choose fix
					temp = (fixString.value).split(""); // sperate the string user input
					
					for(var count = 0; count < temp.length; count++){
						
						switch(temp[count]){
							case "0":
							case "1":
							case "2":
							case "3":
							case "4":
							case "5":
							case "6":
							case "7":
							case "8":
							case "9":
								str = str + temp[count];
								digitIsNeedToFind = 1;// Maybe the number is tens, hundreds, etc.
							break;
							case "+":
							case "-":
							case "*":
							case "/":
							case "(":
							case ")":
								if(digitIsNeedToFind == 1){
									if(first == 1){
										fixString = str;
										first = 0;
										str = "";
										digitIsNeedToFind = 0;
										count = count - 1;
									}else{
										fixString = fixString + " " + str;
										count = count - 1;
										digitIsNeedToFind = 0;
										str = "";
									}
									
								}else{
									if(first == 1){
										fixString = temp[count];
										first = 0;
									}else{
										fixString = fixString + " " + temp[count];
									}
								}
							break;
							default:
								if(digitIsNeedToFind == 1){
									if(first == 1){
										fixString = temp[count];
										first = 0;
									}else{
										fixString = fixString + " " + str;
										digitIsNeedToFind = 0;
										str = "";
									}	
								}
						}// end switch
					}// end for loop

					if(str != ""){ // reserve character need to check
						fixString = fixString + " " + str;
					}
					infixArray = fixString.split(" "); 
					//document.getElementById("currentStepTextArea").innerHTML = fixString;
				}// end if
			}// end if
		}// end function fixPreHandle()

		function doPostfix(){
			
			if(infixArray[infixArrayIndex] == ")"){
				currentStr = currentStr + "\n--->遇到 ) 開始pop堆疊直到遇見 ( ";
				popContinue = 1;
			}
			if(popContinue == 1){
				doStackPop();
			}else{
				if(!isNaN(infixArray[infixArrayIndex])){
					if(first == 1){
						currentStr = currentStr + "\n--->輸出 " + infixArray[infixArrayIndex] + "到後端";
						outputStringStore = infixArray[infixArrayIndex];
						first = 0;
						infixArrayIndex++;
					}else{
						currentStr = currentStr + "\n--->輸出 " + infixArray[infixArrayIndex] + "到後端";
						outputStringStore = outputStringStore + " " + infixArray[infixArrayIndex];
						infixArrayIndex++;
					}
				}else{
					if(doStackPeek() == "empty"){
						currentStr = currentStr + "\n--->堆疊為空 " + infixArray[infixArrayIndex] + " 壓入堆疊";
						doStackPush(infixArray[infixArrayIndex]);
						infixArrayIndex++;
					}else{
						if(getScanPeriority(infixArray[infixArrayIndex]) > getStackUpperPeriority(doStackPeek())){
							currentStr = currentStr + "\n--->因為 " + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + "還高，直接壓入堆疊";
							doStackPush(infixArray[infixArrayIndex]);
							infixArrayIndex++;
						}else if(getScanPeriority(infixArray[infixArrayIndex]) == getStackUpperPeriority(doStackPeek())){
							currentStr = currentStr + "\n--->因為 " + infixArray[infixArrayIndex] + " 的優先權和 " + doStackPeek() + " 一樣";
							currentStr = currentStr + "\n--->要壓入 " + infixArray[infixArrayIndex] + "需先pop出 " + doStackPeek();
							doStackPop();
							currentStr = currentStr + "\n--->但是你得繼續和堆疊的上層運算子繼續比較";
							
							step = 4;
							firstFind = 1;
							decideWhatTimeCanPushInStack();
							//operator = infixArray[infixArrayIndex];
							/**
							////////////////////////////////////////////////////////////////////
							while(getScanPeriority(infixArray[infixArrayIndex]) <= getStackUpperPeriority(doStackPeek())){
								if(doStackPeek() == "empty"){
									break;
								}else{
									currentStr = currentStr + "\n因為 " + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + "一樣";
									currentStr = currentStr + "\n要壓入 " + infixArray[infixArrayIndex] + "需先pop出 " + doStackPeek();
									doStackPop();
								}	
							}

							////////////////////////////////////////////////////////////////////
							if(doStackPeek() != "empty"){
								if(getScanPeriority(infixArray[infixArrayIndex]) > getStackUpperPeriority(doStackPeek())){
									currentStr = currentStr + "\n可以壓入 " + infixArray[infixArrayIndex];
									doStackPush(infixArray[infixArrayIndex]);
									infixArrayIndex++;
								}else{

									outputStringStore = outputStringStore + " " + infixArray[infixArrayIndex];
									infixArrayIndex++;
								}
							}else{
								doStackPop();
								if(doStackPeek() != "empty"){
									while(getScanPeriority(infixArray[infixArrayIndex]) <=getStackUpperPeriority(doStackPeek())){
										if(doStackPeek() == "empty"){
											break;
										}else{
											if(getScanPeriority(infixArray[infixArrayIndex]) <getStackUpperPeriority(doStackPeek())){
											currentStr = currentStr + "\n  " + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + " 小";
											}else{
											currentStr = currentStr + "\n  " + infixArray[infixArrayIndex] + " 的優先權和 " + doStackPeek() + " 一樣";
											}
											doStackPop();
										}	
									}
									doStackPush(infixArray[infixArrayIndex]);
									infixArrayIndex++;
								}else{
									doStackPush(infixArray[infixArrayIndex]);
									infixArrayIndex++;
								}
							}*/
						}else{
							currentStr = currentStr + "\n--->因為 " + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + " 小";
							currentStr = currentStr + "\n--->要壓入 " + infixArray[infixArrayIndex] + "需先pop出 " + doStackPeek();
							doStackPop();
							currentStr = currentStr + "\n--->但是你得繼續和堆疊的上層運算子繼續比較";
							step = 4;
							firstFind = 1;
							decideWhatTimeCanPushInStack();
							/**
							if(doStackPeek() != "empty"){
								////////////////////////////////////////////////////////////////////
								while(getScanPeriority(infixArray[infixArrayIndex]) <=getStackUpperPeriority(doStackPeek())){
									if(doStackPeek() == "empty"){
										break;
									}else{
										if(getScanPeriority(infixArray[infixArrayIndex]) <getStackUpperPeriority(doStackPeek())){
											currentStr = currentStr + "\n" + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + " 小";
										}else{
											currentStr = currentStr + "\n" + infixArray[infixArrayIndex] + " 的優先權和 " + doStackPeek() + " 一樣";
										}
										doStackPop();
									}	
								}
								////////////////////////////////////////////////////////////////////
								doStackPush(infixArray[infixArrayIndex]);
								infixArrayIndex++;
							}else{
								doStackPush(infixArray[infixArrayIndex]);
								infixArrayIndex++;
							}
							*/
							/**
							outputStringStore = outputStringStore + " " + infixArray[infixArrayIndex];
								infixArrayIndex++;*/
						}
					}
				}
			}
			document.getElementById("currentStepTextArea").innerHTML = currentStr;
			allStepWordString = allStepWordString + "\n" + currentStr;
		}

		function decideWhatTimeCanPushInStack(){
			if(firstFind == 0){
				if(doStackPeek() != "empty"){
								
					if(getScanPeriority(infixArray[infixArrayIndex]) > getStackUpperPeriority(doStackPeek())){
						currentStr = currentStr + "\n最後 " + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + "還高，可以壓入堆疊";
						doStackPush(infixArray[infixArrayIndex]);
						infixArrayIndex++;
						step = 1;
						firstFind = 1;
						isAlreadyDecide = 1;
					}else if(getScanPeriority(infixArray[infixArrayIndex]) == getStackUpperPeriority(doStackPeek())){
						currentStr = currentStr + "\n--->因為 " + infixArray[infixArrayIndex] + " 的優先權和 " + doStackPeek() + "一樣";
						doStackPop();
						currentStr = currentStr + "\n還要繼續與堆疊頂端的運算子比較";

					}else if(getScanPeriority(infixArray[infixArrayIndex]) < getStackUpperPeriority(doStackPeek())){
						currentStr = currentStr + "\n--->因為 " + infixArray[infixArrayIndex] + " 的優先權比 " + doStackPeek() + "小";
						doStackPop();
						currentStr = currentStr + "\n還要繼續與堆疊頂端的運算子比較";
					}else{

					}
				}else{
					currentStr = currentStr + "\n現在堆疊為空 " + infixArray[infixArrayIndex] + " 直接壓入堆疊";
					doStackPush(infixArray[infixArrayIndex]);
						infixArrayIndex++;
						step = 1;
						firstFind = 1;
						isAlreadyDecide = 1;
				}
			}else{
				firstFind = 0;
			}
		}

		function getScanPeriority(op1){
			switch(op1){
				case "+":
				case "-":
					return 1;
				break;
				case "*":
				case "/":
					return 2;
				break;
				case "(":
					return 3;
				break;
				default:
			}
		}

		function getStackUpperPeriority(op2){
			switch(op2){
				case "+":
				case "-":
					return 1;
				break;
				case "*":
				case "/":
					return 2;
				break;
				case "(":
					return 0;
				break;
				default:
			}
		}

		function doStackPeek(){
			if(stackStringStore == ""){
				return "empty"
			}else{
				var temp = stackStringStore.split(" "); 
				return temp[temp.length - 1];
			}
		}


		function doStackPop(){
			if(stackStringStore == ""){

			}else{
				var temp = stackStringStore.split(" "); 
				var newStackString = "";
				var button = 1;
				for(var count = 0; count < temp.length - 1; count++){
					if(button == 1){
						newStackString = temp[count];
						button = 0;
					}else{
						newStackString = newStackString + " " + temp[count];
					}
				}
				if(temp[count] == "("){
					popContinue = 0;
					infixArrayIndex++;
				}else{
					outputStringStore = outputStringStore + " " + temp[count];
				}
				currentStr = currentStr + "\nPop " + temp[count];
				stackStringStore = newStackString;
			}
		}

		function doStackPush(op){
			if(stackStringStore == ""){
				stackStringStore = op;
			}else{
				stackStringStore = stackStringStore + " " + op;
			}
		}


		function stepExe(){
			
			//var word = document.getElementById("allStepWordString");
			if(step == 0){
				currentStr = "";
				currentStr = "開始進行中序轉後序，掃描方向為由左到右\n";
				document.getElementById("outputText").value = outputStringStore;
				document.getElementById("stackText").value = stackStringStore;
				allStepWordString = currentStr;
				document.getElementById("currentStepTextArea").innerHTML = currentStr;
				document.getElementById("allStepTextArea").innerHTML = allStepWordString;
				fixPreHandle();
				step++;
			}else if(step == 1){
				if(infixArrayIndex < infixArray.length){
					currentStr = "";
					currentStr = "\nScan: " + infixArray[infixArrayIndex];
					doPostfix();
					document.getElementById("outputText").value = outputStringStore;
					document.getElementById("stackText").value = stackStringStore;
					document.getElementById("allStepTextArea").innerHTML = allStepWordString;
					if(firstFind == 0){
						step = 4;
					}else{
						step = 1;
					}
					
				}else{
					if(doStackPeek() == "empty"){
						step = 3;
					}else{
						currentStr = "";
						currentStr = "\nScan完畢，但堆疊還有運算子";
						doStackPop();
						document.getElementById("currentStepTextArea").innerHTML = currentStr;
						document.getElementById("allStepTextArea").innerHTML = allStepWordString + "\n" + document.getElementById("currentStepTextArea").value;
						allStepWordString = allStepWordString + "\n" + document.getElementById("currentStepTextArea").value; 
						document.getElementById("outputText").value = outputStringStore;
						document.getElementById("stackText").value = stackStringStore;
						step = 2;
					}
					
				}
			}else if(step == 2){
				if(doStackPeek() == "empty"){
					currentStr = "";
					currentStr = "\n中序式轉後序式結束";
					document.getElementById("currentStepTextArea").innerHTML = currentStr;
					document.getElementById("allStepTextArea").innerHTML = allStepWordString + "\n" + currentStr;
					step = 3;
				}else{
					currentStr = "";
					currentStr = "\nScan完畢，但堆疊還有運算子";
					doStackPop();
					document.getElementById("currentStepTextArea").innerHTML = currentStr;
					document.getElementById("allStepTextArea").innerHTML = allStepWordString + "\n" + document.getElementById("currentStepTextArea").value;
					allStepWordString = allStepWordString + "\n" + document.getElementById("currentStepTextArea").value; 
					document.getElementById("outputText").value = outputStringStore;
					document.getElementById("stackText").value = stackStringStore;
					step = 2;
				}

			}else if(step == 4){
				var oldCurrent = currentStr;
				decideWhatTimeCanPushInStack();
				document.getElementById("outputText").value = outputStringStore;
				document.getElementById("stackText").value = stackStringStore;
				var temp = allStepWordString;
				document.getElementById("currentStepTextArea").innerHTML = oldCurrent + "\n" + currentStr;
				document.getElementById("allStepTextArea").innerHTML = allStepWordString + "\n" +currentStr;
				if(isAlreadyDecide == 0){
					allStepWordString = temp;
				}else{
					isAlreadyDecide = 0;
					allStepWordString = allStepWordString + currentStr;
					step = 1;
				}
				
			}else if(step == 3){
				currentStr = "";
				currentStr = "\n中序式轉後序式結束";
				document.getElementById("currentStepTextArea").innerHTML = currentStr;
				document.getElementById("allStepTextArea").innerHTML = allStepWordString + currentStr;
				step = 5;
			}else{

			}
		}// end function stepExe()

		function dataDelete(){
			document.getElementById("inputInfix").value = ""; // text field clear data should use the value attribute.
			document.getElementById("outputText").value = "";
			document.getElementById("stackText").value = "";;
			document.getElementById("allStepTextArea").innerHTML = "";
			document.getElementById("currentStepTextArea").innerHTML = "";
			//document.getElementById("inputInfix").innerHTML = "";
			fixString = "";
			stackStringStore = "";
			outputStringStore = "";
			infixArrayIndex = 0;
			popContinue = 0;
			first = 1;
			allStepWordString = "";
			step = 0;
			currentStr = "";
			firstFind = 1;
			isAlreadyDecide = 0;
		}

		function clearAll(){
			modeClear();
			speedClear();
			fixClear();
			dataDelete();
		}

		//1+(2*3/4-5-6)*7-8*9
	</script>
</html>
